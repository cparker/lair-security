<!DOCTYPE html>

<html>

<head>
  <title>lair security</title>
  <link href="https://fonts.googleapis.com/css?family=Rationale" rel="stylesheet">
  <link rel="stylesheet" href="/main.css" />
  <script defer src="https://use.fontawesome.com/releases/v5.0.4/js/all.js"></script>
</head>

<body>
  <script src="/mystuff/socket.io.js"></script>
  <script src="/mockFaceData.js"></script>
  <script type="text/javascript" src="raspi-stream/http-live-player.js">;</script>

  <audio id="authInSndElm" src="/auth-in.ogg"></audio>
  <audio id="fiveSndElm" src="/five.ogg"></audio>
  <audio id="fourSndElm" src="/four.ogg"></audio>
  <audio id="threeSndElm" src="/three.ogg"></audio>
  <audio id="twoSndElm" src="/two.ogg"></audio>
  <audio id="oneSndElm" src="/one.ogg"></audio>
  <audio id="zeroSndElm" src="/zero.ogg"></audio>
  <audio id="analyzingSndElm" src="/analyzing.ogg"></audio>
  <audio id="authFailedSndElm" src="/auth-failed.ogg"></audio>
  <audio id="authOKSndElm" src="/authenticated.ogg"></audio>



  <div class="center-column">
    <div class="top-text">
      <div id="authOK">AUTHENTICATION OK</div>
      <div id="authenticateIn">AUTHENTICATE IN <span class="count-down">5</span></div>
      <div id="analyzing">ANALYZING <i class="fas fa-sync fa-spin"></i></div>
      <div id="authFailed">AUTHENTICATION FAILED <i class="fas fa-exclamation-triangle"></i></div>
    </div>
    <div class="canvas-wrapper">
      <canvas id="mainCanvas"></canvas>
      <canvas id="faceGeometry"></canvas>
      <img class="still-image" src="hugh.jpg"/>
      <div id="textOnVideo" class="text-on-video">
        <div id="faceStatsLabelBox" class="labels">
          <div class="label">Age:</div>
          <div class="label">Sex:</div>
          <div class="label">Beard:</div>
          <div class="label">Smile:</div>
        </div>
        <div id="faceStatsBox" class="values">
          <div id="ageValueElm" class="value"></div>
          <div id="sexValueElm" class="value"></div>
          <div id="beardValueElm" class="value"></div>
          <div id="smileValueElm" class="value"></div>
        </div>
      </div>
    </div>
  </div>

  <input class="buttons" id="snap" type="button" value="snap"></input>
  <input class="buttons" id="start" type="button" value="start"></input>
  <input class="buttons" id="startCountdown" type="button" value="start countdown"></input>
  <input class="buttons" id="authFailedBtn" type="button" value="auth failed"></input>
  <input class="buttons" id="vidImageToggle" type="button" value="vid image toggle"></input>
  <input class="buttons" id="drawFaceGeoBtn" type="button" value="draw face geo"></input>


  <script>
    let stillImage
    let snap, start
    let mySocket
    let mainCanvas, secondCanvas
    let countDown
    let startCountdown
    let authOKElm, authenticateInElm, analyzingElm, authFailedElm
    let stillImageElm
    let showVid = true
    let faveGeoCanvas, faceGeoContext
    let authInSndElm, fiveSndElm, fourSndElm, threeSndElm, twoSndElm, oneSndElm, zeroSndElm, analyzingSndElm, authFailedSndElm, authOKSndElm
    let ageValueElm, sexValueElm, beardValueElm, smileValueElm
    let faceStatsBox, faceStatsLabelBox, textOnVideo

    const imageWidth = 1280
    const imageHeight = 720

    function init() {
      stillImage = document.querySelector(".still-image")
      mainCanvas = document.querySelector("#mainCanvas")
      snap = document.querySelector("#snap")
      start = document.querySelector("#start")
      mySocket = io('/fred',{path:'/mystuff'}).connect()
      countDown = document.querySelector('.count-down')
      startCountdown = document.querySelector('#startCountdown')
      authOKElm = document.querySelector('#authOK')
      authenticateInElm = document.querySelector('#authenticateIn')
      analyzingElm = document.querySelector('#analyzing')
      authFailedElm = document.querySelector('#authFailed')
      stillImageElm = document.querySelector('.still-image')
      faceGeoCanvas = document.querySelector('#faceGeometry')

      authInSndElm = document.querySelector('#authInSndElm')
      fiveSndElm = document.querySelector('#fiveSndElm')
      fourSndElm = document.querySelector('#fourSndElm')
      threeSndElm = document.querySelector('#threeSndElm')
      twoSndElm = document.querySelector('#twoSndElm')
      oneSndElm = document.querySelector('#oneSndElm')
      zeroSndElm = document.querySelector('#zeroSndElm')
      analyzingSndElm = document.querySelector('#analyzingSndElm')
      authFailedSndElm = document.querySelector('#authFailedSndElm')
      authOKSndElm = document.querySelector('#authOKSndElm')

      faceStatsLabelBox = document.querySelector('#faceStatsLabelBox')
      faceStatsBox = document.querySelector('#faceStatsBox')
      ageValueElm = document.querySelector('#ageValueElm')
      sexValueElm = document.querySelector('#sexValueElm')
      beardValueElm = document.querySelector('#beardValueElm')
      smileValueElm = document.querySelector('#smileValueElm')

      textOnVideo = document.querySelector('#textOnVideo')

      textElements = [authOKElm, authenticateInElm, analyzingElm, authFailedElm]

      soundMap = {
        5: fiveSndElm,
        4: fourSndElm,
        3: threeSndElm,
        2: twoSndElm,
        1: oneSndElm,
        0: zeroSndElm
      }

      faceGeoCanvas.width = imageWidth
      faceGeoCanvas.height = imageHeight
      faceGeoContext = faceGeoCanvas.getContext("2d")


      const authOK = () => {
        textElements.forEach(e => e.style.display = 'none')
        authOKElm.style.display = 'block';
        authOKSndElm.currentTime = 0
        authOKSndElm.play()
      }

      const authenticateIn = () => {
        textElements.forEach(e => e.style.display = 'none')
        authenticateInElm.style.display = 'block';
        authInSndElm.currentTime = 0
        authInSndElm.play()
      }

      function uploadSnapAndCompare() {
        let picURL = mainCanvas.toDataURL()
        return fetch('/uploadSnapAndCompare', {
          method: 'POST',
          body: picURL
        })
      }

      function takeSnapAndCompare() {
        analyzing()
        uploadSnapAndCompare()
          .then(result => {
            console.log('uploaded snap returned')
            return result.json()
          })
          .then(data => {
            console.log('uploadSnapCompareResponseData', data)
          })
          .catch(err => {
            console.log('error uploading snapshot', err)
          })
      }

      const analyzing = () => {
        textElements.forEach(e => e.style.display = 'none')
        analyzingElm.style.display = 'block';
        analyzingSndElm.currentTime = 0
        analyzingSndElm.play()
      }

      const authFailed = () => {
        textElements.forEach(e => e.style.display = 'none')
        authFailedElm.style.display = 'block';
        authFailedSndElm.currentTime = 0
        authFailedSndElm.play()
      }



      snap.addEventListener('click', () => {
        console.log('snappy, take picture of canvas')
        let picURL = mainCanvas.toDataURL()
        fetch('/savepic', {
          method: 'POST',
          body: picURL
        })
      })

      start.addEventListener('click', () => {
        console.log('start')
        videoPlayer.playStream()
      })

      startCountdown.addEventListener('click', () => {
        authenticateIn()
        let count = 5
        const countInterval = setInterval(() => {
          if (count < 0) {
            clearInterval(countInterval)
            takeSnapAndCompare()
          } else {
            countDown.innerHTML = `${count}`
            const countSound = soundMap[count]
            countSound.currentTime = 0
            countSound.play()
            count--
          }
        }, 1000)
      })

      authFailedBtn.addEventListener('click', () => {
        authFailed()
      })

      vidImageToggle.addEventListener('click', () => {
        if (showVid) {
          mainCanvas.style.display='none'
          stillImageElm.style.display='block'
          showVid = false
        } else {
          mainCanvas.style.display='block'
          stillImageElm.style.display='none'
          showVid = true
        }
      })

      drawFaceGeoBtn.addEventListener('click', () => {
        drawFaceGeo()
        addFaceStats()
      })

      // Create h264 player
      let uri = `ws://${document.location.host}/video`
      console.log(`ws uri is ${uri}`)
      let videoPlayer = new WSAvcPlayer(mainCanvas, "webgl", 1, 35)
      videoPlayer.connect(uri)

      // SOCKET EvENTS
      mySocket.on('connect', c => {
        console.log('connected', c)
      })

      mySocket.on('test', d => {
        console.log('got a test event', d)
      })

    }

    function drawFaceGeo() {
      testFaceData.FaceDetails[0].Landmarks.forEach(point => { // first face
        let xCoord = Math.floor(point.X * stillImage.width)
        let yCoord = Math.floor(point.Y * stillImage.height)
        console.log(`NEW xCoord ${xCoord} yCoord ${yCoord}`)
        faceGeoContext.beginPath();
        faceGeoContext.arc(xCoord, yCoord, 2, 0, 2 * Math.PI, false);
        faceGeoContext.lineWidth = 2;
        faceGeoContext.strokeStyle = '#00ff00';
        faceGeoContext.stroke();
      })
    }

    function addFaceStats() {
      textOnVideo.style.visibility = 'visible'

      ageValueElm.innerHTML = `${testFaceData.FaceDetails[0].AgeRange.Low} - ${testFaceData.FaceDetails[0].AgeRange.High}`
      sexValueElm.innerHTML = `${testFaceData.FaceDetails[0].Gender.Confidence.toFixed(1)}% ${testFaceData.FaceDetails[0].Gender.Value}`
      beardValueElm.innerHTML = `${testFaceData.FaceDetails[0].Beard.Confidence.toFixed(1)}% ${testFaceData.FaceDetails[0].Beard.Value}`
      smileValueElm.innerHTML = `${testFaceData.FaceDetails[0].Smile.Confidence.toFixed(1)}%  ${testFaceData.FaceDetails[0].Smile.Value}`
      testFaceData.FaceDetails[0].Emotions.forEach(e => {
        const newLabel = document.createElement('div')
        newLabel.classList.add('label')
        const cleanLabel = e.Type.toLowerCase().substr(0,1).toUpperCase() + e.Type.toLowerCase().substr(1)
        newLabel.innerHTML = `${cleanLabel}:`
        faceStatsLabelBox.appendChild(newLabel)

        const newStat = document.createElement('div')
        newStat.classList.add('value')
        newStat.innerHTML = `${e.Confidence.toFixed(1)}%`
        faceStatsBox.appendChild(newStat)
      })
    }

    window.onload = () => {
      console.log('onload')
      init()
    }
  </script>
</body>

</html>
